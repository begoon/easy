PROGRAM MasterMind:

TYPE Universe IS ARRAY[0 : 1295] OF INTEGER;
TYPE Comparison IS STRUCTURE 
  FIELD in_place IS INTEGER,
  FIELD by_value IS INTEGER
END STRUCTURE;

DECLARE (universe, candidates) Universe;
DECLARE (eliminated_candidates, remaining_candidates) INTEGER;

DECLARE comparison Comparison;

DECLARE (in_place, by_value) INTEGER;
DECLARE tries INTEGER;

FUNCTION CreateUniverse() Universe:
  DECLARE u Universe;
  DECLARE (i, j, k, l) INTEGER;
  FOR i := 0 TO 5 DO
    FOR j := 0 TO 5 DO
      FOR k := 0 TO 5 DO
        FOR l := 0 TO 5 DO
          DECLARE (v, offset) INTEGER;
          SET v := i * 1000 + j * 100 + k * 10 + l + 1111;
          SET offset := (i * 6 * 6 + j * 6 + k) * 6 + l;
          SET u[offset] := v;
        END FOR;
      END FOR;
    END FOR;
  END FOR;
  RETURN u;
END FUNCTION CreateUniverse;

FUNCTION compare(probe INTEGER, code INTEGER) Comparison:
  DECLARE (p1, p2, p3, p4) INTEGER;
  DECLARE (c1, c2, c3, c4) INTEGER;

  DECLARE comparison Comparison;

  SET p1 := probe / 1000 MOD 10;
  SET p2 := probe / 100 MOD 10;
  SET p3 := probe / 10 MOD 10;
  SET p4 := probe MOD 10;

  SET c1 := code / 1000 MOD 10;
  SET c2 := code / 100 MOD 10;
  SET c3 := code / 10 MOD 10;
  SET c4 := code MOD 10;

  SET comparison.in_place := 0;
  SET comparison.by_value := 0;

  IF p1 = c1 THEN
    SET comparison.in_place := comparison.in_place + 1;
    SET c1 := -1;
  FI;

  IF p2 = c2 THEN
    SET comparison.in_place := comparison.in_place + 1;
    SET c2 := -1;
  FI;

  IF p3 = c3 THEN
    SET comparison.in_place := comparison.in_place + 1;
    SET c3 := -1;
  FI;

  IF p4 = c4 THEN
    SET comparison.in_place := comparison.in_place + 1;
    SET c4 := -1;
  FI;

  IF p1 = c2 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c2 := -1;
  ELSE IF p1 = c3 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c3 := -1;
  ELSE IF p1 = c4 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c4 := -1;
  FI; FI; FI;

  IF p2 = c1 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c1 := -1;
  ELSE IF p2 = c3 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c3 := -1;
  ELSE IF p2 = c4 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c4 := -1;
  FI; FI; FI;

  IF p3 = c1 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c1 := -1;
  ELSE IF p3 = c2 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c2 := -1;
  ELSE IF p3 = c4 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c4 := -1;
  FI; FI; FI;

  IF p4 = c1 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c1 := -1;
  ELSE IF p4 = c2 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c2 := -1;
  ELSE IF p4 = c3 THEN
    SET comparison.by_value := comparison.by_value + 1;
    SET c3 := -1;
  FI; FI; FI;

  RETURN comparison;
END FUNCTION compare;

SET universe := CreateUniverse();
SET candidates := CreateUniverse();

// FOR i := 0 TO 1295 DO
//   OUTPUT universe[i], " ";
// END FOR;

// OUTPUT "  ";

// SET comparison := Compare(1234, 4321);
// OUTPUT "compare 1234 vs 4321: ", comparison.in_place, ":", comparison.by_value, "  ";
// SET comparison := Compare(1111, 1111);
// OUTPUT "compare 1111 vs 1111: ", comparison.in_place, ":", comparison.by_value, "  ";
// SET comparison := Compare(1234, 1234);
// OUTPUT "compare 1234 vs 1234: ", comparison.in_place, ":", comparison.by_value, "  ";
// SET comparison := Compare(1234, 5612);  
// OUTPUT "compare 1234 vs 5612: ", comparison.in_place, ":", comparison.by_value, "  ";
// SET comparison := Compare(1234, 3456);  
// OUTPUT "compare 1234 vs 3456: ", comparison.in_place, ":", comparison.by_value, "  ";
// SET comparison := Compare(1212, 1221);  
// OUTPUT "compare 1212 vs 1221: ", comparison.in_place, ":", comparison.by_value, "  ";
// SET comparison := Compare(1211, 1261);  
// OUTPUT "compare 1211 vs 1261: ", comparison.in_place, ":", comparison.by_value, "  ";
// SET comparison := Compare(1111, 1211);  
// OUTPUT "compare 1111 vs 1211: ", comparison.in_place, ":", comparison.by_value, "  ";

FOR tries := 1 WHILE TRUE DO
  DECLARE (best_rank, best_probe) INTEGER;
  DECLARE probe_index INTEGER;
  DECLARE candidate_index INTEGER;
  DECLARE probe INTEGER;

  // knuth's minimax algorithm
  FOR probe_index := 0 TO 1295 DO
    DECLARE probe_not_in_candidates INTEGER;

    DECLARE buckets ARRAY[0 : 44] OF INTEGER; // max is 4*10 + 4 = 44
    DECLARE bucket_index INTEGER;


    DECLARE rank INTEGER;
    DECLARE worst_evaluation INTEGER;

    SET probe_not_in_candidates := 1;
    SET worst_evaluation := -1;

    FOR bucket_index := 0 TO 16 DO SET buckets[bucket_index] := -1; END FOR;

    FOR candidate_index := 0 TO 1295 DO
      DECLARE candidate INTEGER;

      IF candidates[candidate_index] = universe[probe_index] THEN
        SET probe_not_in_candidates := 0;
      FI;

      SET candidate := candidates[candidate_index];
      IF candidate <> 0 THEN
        DECLARE comparison Comparison;
        DECLARE bucket_index INTEGER;
        SET comparison := compare(candidate, universe[probe_index]);
        SET bucket_index := comparison.in_place * 10 + comparison.by_value;
        SET buckets[bucket_index] := buckets[bucket_index] + 1;

        IF buckets[bucket_index] > worst_evaluation THEN SET worst_evaluation := buckets[bucket_index]; FI;
      FI;

    END FOR;

    SET rank := probe + probe_not_in_candidates * 1000 + worst_evaluation * 10000;
    IF best_rank = 0 | rank < best_rank THEN
      SET best_rank := rank;
      SET best_probe := probe;
    FI; 
    
  END FOR;

  OUTPUT "is it ", best_probe, "? ";
  OUTPUT "#", tries, ", enter matches in-place and by-value: (e.g. '1 2' for 1 in place and 2 by value):", " ";
  INPUT in_place, by_value;

  IF in_place = 4 THEN
    OUTPUT "guesses in ", tries, " tries";
    EXIT;
  FI;

  SET tries := tries + 1;

  SET eliminated_candidates := 0;
  SET remaining_candidates := 0;

  // eliminate candidates that do not match the feedback
  FOR candidate_index := 0 TO 1295 DO
    DECLARE candidate INTEGER;
    DECLARE comparison Comparison;

    SET candidate := candidates[candidate_index];
    IF candidate <> 0 THEN
      SET comparison := compare(probe, candidate);
      IF comparison.in_place <> in_place | comparison.by_value <> by_value THEN
        SET candidates[candidate_index] := 0;
        SET eliminated_candidates := eliminated_candidates + 1;
      ELSE
        SET remaining_candidates := remaining_candidates + 1;
      FI;
    FI;
  END FOR;
  OUTPUT eliminated_candidates, " candidates eliminated, ", remaining_candidates, " remaining.";
END FOR;

END PROGRAM MasterMind;
